generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  passwordHash  String         @map("password_hash")
  name          String
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  activityLogs  ActivityLog[]
  notifications Notification[]
  refreshTokens RefreshToken[]
  sales         Sale[]
  ownedShops    Shop[]         @relation("ShopOwner")
  staffShops    StaffShop[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  revoked   Boolean  @default(false)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Shop {
  id                  String            @id @default(uuid())
  name                String
  address             String?
  target              Decimal?          @db.Decimal(10, 2)
  ownerId             String            @map("owner_id")
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")
  heroSubtitle        String?           @map("hero_subtitle")
  heroTitle           String?           @map("hero_title")
  primaryColor        String?           @default("blue") @map("primary_color")
  isStorefrontEnabled Boolean           @default(true) @map("is_storefront_enabled")
  activityLogs        ActivityLog[]
  customers           Customer[]
  notifications       Notification[]
  offlineSaleSyncs    OfflineSaleSync[]
  products            Product[]
  purchaseOrders      PurchaseOrder[]
  roles               Role[]
  sales               Sale[]
  owner               User              @relation("ShopOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  staff               StaffShop[]
  suppliers           Supplier[]

  @@map("shops")
}

model StaffShop {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  shopId   String   @map("shop_id")
  roleId   String   @map("role_id")
  joinedAt DateTime @default(now()) @map("joined_at")
  isActive Boolean  @default(true) @map("is_active")
  role     Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  shop     Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, shopId])
  @@map("staff_shops")
}

model Role {
  id              String           @id @default(uuid())
  shopId          String           @map("shop_id")
  name            String
  description     String?
  isSystem        Boolean          @default(false) @map("is_system")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  rolePermissions RolePermission[]
  shop            Shop             @relation(fields: [shopId], references: [id], onDelete: Cascade)
  staffShops      StaffShop[]

  @@unique([shopId, name])
  @@map("roles")
}

model Permission {
  id              String           @id @default(uuid())
  name            String           @unique
  description     String?
  category        String
  createdAt       DateTime         @default(now()) @map("created_at")
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model Supplier {
  id             String          @id @default(uuid())
  shopId         String          @map("shop_id")
  name           String
  contactPerson  String?         @map("contact_person")
  email          String?
  phone          String?
  address        String?
  notes          String?
  totalOrders    Int             @default(0) @map("total_orders")
  totalSpent     Decimal         @default(0) @map("total_spent") @db.Decimal(10, 2)
  lastOrder      DateTime?       @map("last_order")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  products       Product[]
  purchaseOrders PurchaseOrder[]
  shop           Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId, name])
  @@index([shopId, phone])
  @@index([shopId, email])
  @@map("suppliers")
}

model Product {
  id                 String              @id @default(uuid())
  shopId             String              @map("shop_id")
  name               String
  stock              Int                 @default(0)
  price              Decimal             @db.Decimal(10, 2)
  categoryName       String?             @map("category_name")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  supplierId         String?             @map("supplier_id")
  costPrice          Decimal?            @map("cost_price") @db.Decimal(10, 2)
  isFeatured         Boolean             @default(false) @map("is_featured")
  shop               Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  supplier           Supplier?           @relation(fields: [supplierId], references: [id])
  purchaseOrderItems PurchaseOrderItem[]
  saleItems          SaleItem[]

  @@map("products")
}

model Sale {
  id                 String           @id @default(uuid())
  orderId            String           @unique @map("order_id")
  shopId             String           @map("shop_id")
  staffId            String           @map("staff_id")
  totalAmount        Decimal          @map("total_amount") @db.Decimal(10, 2)
  createdAt          DateTime         @default(now()) @map("created_at")
  customerId         String?          @map("customer_id")
  accountNumber      String?          @map("account_number")
  amountPaid         Decimal          @default(0) @map("amount_paid") @db.Decimal(10, 2)
  bankName           String?          @map("bank_name")
  outstandingBalance Decimal          @default(0) @map("outstanding_balance") @db.Decimal(10, 2)
  paymentMethod      String?          @map("payment_method")
  paymentStatus      String           @default("completed") @map("payment_status")
  paymentType        String           @default("full") @map("payment_type")
  customerNote       String?          @map("customer_note")
  isOnlineOrder      Boolean          @default(false) @map("is_online_order")
  orderStatus        String           @default("completed") @map("order_status")
  proofOfPayment     String?          @map("proof_of_payment")
  installments       Installment[]
  offlineSync        OfflineSaleSync?
  saleItems          SaleItem[]
  customer           Customer?        @relation(fields: [customerId], references: [id])
  shop               Shop             @relation(fields: [shopId], references: [id], onDelete: Cascade)
  staff              User             @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("sales")
}

model Installment {
  id            String   @id @default(uuid())
  saleId        String   @map("sale_id")
  amount        Decimal  @db.Decimal(10, 2)
  paymentMethod String   @map("payment_method")
  bankName      String?  @map("bank_name")
  accountNumber String?  @map("account_number")
  createdAt     DateTime @default(now()) @map("created_at")
  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("installments")
}

model SaleItem {
  id              String  @id @default(uuid())
  saleId          String  @map("sale_id")
  productId       String  @map("product_id")
  quantity        Int
  price           Decimal @db.Decimal(10, 2)
  costPrice       Decimal @default(0) @map("cost_price") @db.Decimal(10, 2)
  discountPercent Decimal @default(0) @map("discount_percent") @db.Decimal(5, 2)
  product         Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  sale            Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("sale_items")
}

model ActivityLog {
  id        String   @id @default(uuid())
  shopId    String   @map("shop_id")
  staffId   String   @map("staff_id")
  action    String
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  staff     User     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

model Notification {
  id        String   @id @default(uuid())
  shopId    String   @map("shop_id")
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  data      Json?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([shopId, createdAt])
  @@map("notifications")
}

model Customer {
  id           String        @id @default(uuid())
  shopId       String        @map("shop_id")
  name         String
  email        String?
  phone        String?
  address      String?
  totalSpent   Decimal       @default(0) @map("total_spent") @db.Decimal(10, 2)
  visitCount   Int           @default(0) @map("visit_count")
  lastVisit    DateTime?     @map("last_visit")
  notes        String?
  tags         String[]      @default([])
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  password     String?
  shop         Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  loyaltyPoint LoyaltyPoint?
  sales        Sale[]

  @@index([shopId, name])
  @@index([shopId, phone])
  @@index([shopId, email])
  @@map("customers")
}

model LoyaltyPoint {
  id         String   @id @default(uuid())
  customerId String   @unique @map("customer_id")
  points     Int      @default(0)
  tier       String   @default("bronze")
  updatedAt  DateTime @updatedAt @map("updated_at")
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("loyalty_points")
}

model OfflineSaleSync {
  id           String   @id @default(uuid())
  shopId       String   @map("shop_id")
  clientTempId String   @map("client_temp_id")
  saleId       String   @unique @map("sale_id")
  createdAt    DateTime @default(now()) @map("created_at")
  sale         Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  shop         Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, clientTempId])
  @@map("offline_sale_syncs")
}

model PurchaseOrder {
  id          String              @id @default(uuid())
  poNumber    String              @unique @map("po_number")
  shopId      String              @map("shop_id")
  supplierId  String              @map("supplier_id")
  status      String              @default("draft")
  totalAmount Decimal             @default(0) @map("total_amount") @db.Decimal(10, 2)
  notes       String?
  sentAt      DateTime?           @map("sent_at")
  receivedAt  DateTime?           @map("received_at")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  items       PurchaseOrderItem[]
  shop        Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  supplier    Supplier            @relation(fields: [supplierId], references: [id])

  @@index([shopId, status])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String        @id @default(uuid())
  purchaseOrderId  String        @map("purchase_order_id")
  productId        String        @map("product_id")
  quantityOrdered  Int           @map("quantity_ordered")
  quantityReceived Int           @default(0) @map("quantity_received")
  unitCost         Decimal       @map("unit_cost") @db.Decimal(10, 2)
  product          Product       @relation(fields: [productId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("purchase_order_items")
}
